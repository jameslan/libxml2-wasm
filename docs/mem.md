---
layout: page
title: Memory Management
permalink: /docs/mem.html
---

The architecture of libxml2-wasm is shown as the following diagram.

<img src="data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%20standalone%3D%22no%22%3F%3E%3C%21DOCTYPE%20svg%20PUBLIC%20%22-//W3C//DTD%20SVG%201.1//EN%22%20%22http%3A//www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd%22%3E%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axl%3D%22http%3A//www.w3.org/1999/xlink%22%20xmlns%3Adc%3D%22http%3A//purl.org/dc/elements/1.1/%22%20version%3D%221.1%22%20viewBox%3D%22299%2089%20490%20293%22%20width%3D%22490%22%20height%3D%22293%22%3E%3Cdefs%3E%3Cfilter%20id%3D%22Shadow%22%20filterUnits%3D%22userSpaceOnUse%22%20x%3D%22250%22%20y%3D%2259.7%22%3E%3CfeGaussianBlur%20in%3D%22SourceAlpha%22%20result%3D%22blur%22%20stdDeviation%3D%221.308%22/%3E%3CfeOffset%20in%3D%22blur%22%20result%3D%22offset%22%20dx%3D%220%22%20dy%3D%222%22/%3E%3CfeFlood%20flood-color%3D%22black%22%20flood-opacity%3D%22.5%22%20result%3D%22flood%22/%3E%3CfeComposite%20in%3D%22flood%22%20in2%3D%22offset%22%20operator%3D%22in%22%20result%3D%22color%22/%3E%3CfeMerge%3E%3CfeMergeNode%20in%3D%22color%22/%3E%3CfeMergeNode%20in%3D%22SourceGraphic%22/%3E%3C/feMerge%3E%3C/filter%3E%3Cmarker%20orient%3D%22auto%22%20overflow%3D%22visible%22%20markerUnits%3D%22strokeWidth%22%20id%3D%22FilledArrow_Marker%22%20stroke-linejoin%3D%22miter%22%20stroke-miterlimit%3D%2210%22%20viewBox%3D%22-1%20-4%208%208%22%20markerWidth%3D%228%22%20markerHeight%3D%228%22%20color%3D%22black%22%3E%3Cg%3E%3Cpath%20d%3D%22M%206%200%20L%200%20-2.25%20L%200%202.25%20Z%22%20fill%3D%22currentColor%22%20stroke%3D%22currentColor%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3C/marker%3E%3Cmarker%20orient%3D%22auto%22%20overflow%3D%22visible%22%20markerUnits%3D%22strokeWidth%22%20id%3D%22FilledArrow_Marker_2%22%20stroke-linejoin%3D%22miter%22%20stroke-miterlimit%3D%2210%22%20viewBox%3D%22-1%20-4%2010%208%22%20markerWidth%3D%2210%22%20markerHeight%3D%228%22%20color%3D%22black%22%3E%3Cg%3E%3Cpath%20d%3D%22M%208%200%20L%200%20-3%20L%200%203%20Z%22%20fill%3D%22currentColor%22%20stroke%3D%22currentColor%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3C/marker%3E%3Cmarker%20orient%3D%22auto%22%20overflow%3D%22visible%22%20markerUnits%3D%22strokeWidth%22%20id%3D%22FilledArrow_Marker_3%22%20stroke-linejoin%3D%22miter%22%20stroke-miterlimit%3D%2210%22%20viewBox%3D%22-1%20-4%2010%208%22%20markerWidth%3D%2210%22%20markerHeight%3D%228%22%20color%3D%22black%22%3E%3Cg%3E%3Cpath%20d%3D%22M%208%200%20L%200%20-3%20L%200%203%20Z%22%20fill%3D%22currentColor%22%20stroke%3D%22currentColor%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3C/marker%3E%3C/defs%3E%3Cg%20id%3D%22Canvas_1%22%20fill-opacity%3D%221%22%20stroke-opacity%3D%221%22%20stroke-dasharray%3D%22none%22%20stroke%3D%22none%22%20fill%3D%22none%22%3E%3Ctitle%3ECanvas%201%3C/title%3E%3Crect%20fill%3D%22white%22%20x%3D%22299%22%20y%3D%2289%22%20width%3D%22490%22%20height%3D%22293%22/%3E%3Cg%20id%3D%22Canvas_1_Layer_1%22%3E%3Ctitle%3ELayer%201%3C/title%3E%3Cg%20id%3D%22Graphic_18%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Cpath%20d%3D%22M%20306.5%2091%20L%20781.5%2091%20C%20783.7091%2091%20785.5%2092.79086%20785.5%2095%20L%20785.5%20372%20C%20785.5%20374.20914%20783.7091%20376%20781.5%20376%20L%20306.5%20376%20C%20304.29086%20376%20302.5%20374.20914%20302.5%20372%20L%20302.5%2095%20C%20302.5%2092.79086%20304.29086%2091%20306.5%2091%20Z%22%20fill%3D%22white%22/%3E%3Cpath%20d%3D%22M%20306.5%2091%20L%20781.5%2091%20C%20783.7091%2091%20785.5%2092.79086%20785.5%2095%20L%20785.5%20372%20C%20785.5%20374.20914%20783.7091%20376%20781.5%20376%20L%20306.5%20376%20C%20304.29086%20376%20302.5%20374.20914%20302.5%20372%20L%20302.5%2095%20C%20302.5%2092.79086%20304.29086%2091%20306.5%2091%20Z%22%20stroke%3D%22gray%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28307.5%2096%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2212%22%20fill%3D%22black%22%20x%3D%22191.158%22%20y%3D%2211%22%3EProcess%20Memory%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_10%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Cpath%20d%3D%22M%20528.5%20133.5%20L%20654%20133.5%20C%20656.2091%20133.5%20658%20135.29086%20658%20137.5%20L%20658%20348%20C%20658%20350.20914%20656.2091%20352%20654%20352%20L%20528.5%20352%20C%20526.29086%20352%20524.5%20350.20914%20524.5%20348%20L%20524.5%20137.5%20C%20524.5%20135.29086%20526.29086%20133.5%20528.5%20133.5%20Z%22%20fill%3D%22white%22/%3E%3Cpath%20d%3D%22M%20528.5%20133.5%20L%20654%20133.5%20C%20656.2091%20133.5%20658%20135.29086%20658%20137.5%20L%20658%20348%20C%20658%20350.20914%20656.2091%20352%20654%20352%20L%20528.5%20352%20C%20526.29086%20352%20524.5%20350.20914%20524.5%20348%20L%20524.5%20137.5%20C%20524.5%20135.29086%20526.29086%20133.5%20528.5%20133.5%20Z%22%20stroke%3D%22gray%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28529.5%20138.5%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2212%22%20fill%3D%22black%22%20x%3D%2218.958%22%20y%3D%2211%22%3EShared%20Memory%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_2%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22591.25%22%20cy%3D%22189.5%22%20r%3D%2220.5000327569888%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22591.25%22%20cy%3D%22189.5%22%20r%3D%2220.5000327569888%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28579.85%20184.388%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%228%22%20fill%3D%22black%22%20x%3D%224.5839996%22%20y%3D%228%22%3Edoc%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_3%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22591.25%22%20cy%3D%22255.75%22%20r%3D%2220.5000327569888%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22591.25%22%20cy%3D%22255.75%22%20r%3D%2220.5000327569888%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28579.85%20250.638%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%228%22%20fill%3D%22black%22%20x%3D%222.3599996%22%20y%3D%228%22%3Enode%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Line_6%22%3E%3Cline%20x1%3D%22591.25%22%20y1%3D%22210%22%20x2%3D%22591.25%22%20y2%3D%22227.35%22%20marker-end%3D%22url%28%23FilledArrow_Marker%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Graphic_11%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22455.25%22%20cy%3D%22263.75%22%20r%3D%2210.7500171774454%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22455.25%22%20cy%3D%22263.75%22%20r%3D%2210.7500171774454%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Line_12%22%3E%3Cline%20x1%3D%22464.68785%22%20y1%3D%22258.59735%22%20x2%3D%22564.5629%22%20y2%3D%22204.06997%22%20marker-end%3D%22url%28%23FilledArrow_Marker_2%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Graphic_13%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Cpath%20d%3D%22M%20672%20257.5%20L%20761%20257.5%20C%20763.2091%20257.5%20765%20259.29086%20765%20261.5%20L%20765%20348%20C%20765%20350.20914%20763.2091%20352%20761%20352%20L%20672%20352%20C%20669.7909%20352%20668%20350.20914%20668%20348%20L%20668%20261.5%20C%20668%20259.29086%20669.7909%20257.5%20672%20257.5%20Z%22%20fill%3D%22white%22/%3E%3Cpath%20d%3D%22M%20672%20257.5%20L%20761%20257.5%20C%20763.2091%20257.5%20765%20259.29086%20765%20261.5%20L%20765%20348%20C%20765%20350.20914%20763.2091%20352%20761%20352%20L%20672%20352%20C%20669.7909%20352%20668%20350.20914%20668%20348%20L%20668%20261.5%20C%20668%20259.29086%20669.7909%20257.5%20672%20257.5%20Z%22%20stroke%3D%22gray%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28673%20277.078%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2216%22%20fill%3D%22black%22%20x%3D%2227.508%22%20y%3D%2215%22%3EWeb%20%3C/tspan%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2216%22%20fill%3D%22black%22%20x%3D%228.676%22%20y%3D%2233.448%22%3EAssembly%20%3C/tspan%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2216%22%20fill%3D%22black%22%20x%3D%2216.676%22%20y%3D%2251.895996%22%3EModule%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_14%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22455.25%22%20cy%3D%22298.25%22%20r%3D%2210.7500171774454%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22455.25%22%20cy%3D%22298.25%22%20r%3D%2210.7500171774454%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Graphic_17%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Cpath%20d%3D%22M%20327%20257.5%20L%20416%20257.5%20C%20418.20914%20257.5%20420%20259.29086%20420%20261.5%20L%20420%20348%20C%20420%20350.20914%20418.20914%20352%20416%20352%20L%20327%20352%20C%20324.79086%20352%20323%20350.20914%20323%20348%20L%20323%20261.5%20C%20323%20259.29086%20324.79086%20257.5%20327%20257.5%20Z%22%20fill%3D%22white%22/%3E%3Cpath%20d%3D%22M%20327%20257.5%20L%20416%20257.5%20C%20418.20914%20257.5%20420%20259.29086%20420%20261.5%20L%20420%20348%20C%20420%20350.20914%20418.20914%20352%20416%20352%20L%20327%20352%20C%20324.79086%20352%20323%20350.20914%20323%20348%20L%20323%20261.5%20C%20323%20259.29086%20324.79086%20257.5%20327%20257.5%20Z%22%20stroke%3D%22gray%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28328%20286.302%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2216%22%20fill%3D%22black%22%20x%3D%226.756%22%20y%3D%2215%22%3EJavascript%20%3C/tspan%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%2216%22%20fill%3D%22black%22%20x%3D%2216.676%22%20y%3D%2233.448%22%3EModule%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_19%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22617.5%22%20cy%3D%22317.625%22%20r%3D%2220.5000327569889%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22617.5%22%20cy%3D%22317.625%22%20r%3D%2220.5000327569889%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28606.1%20312.513%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%228%22%20fill%3D%22black%22%20x%3D%222.3599996%22%20y%3D%228%22%3Enode%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Graphic_20%22%20filter%3D%22url%28%23Shadow%29%22%3E%3Ccircle%20cx%3D%22558.5%22%20cy%3D%22317.625%22%20r%3D%2220.5000327569889%22%20fill%3D%22white%22/%3E%3Ccircle%20cx%3D%22558.5%22%20cy%3D%22317.625%22%20r%3D%2220.5000327569889%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3Ctext%20transform%3D%22translate%28547.1%20312.513%29%22%20fill%3D%22black%22%3E%3Ctspan%20font-family%3D%22Helvetica%20Neue%22%20font-size%3D%228%22%20fill%3D%22black%22%20x%3D%222.3599996%22%20y%3D%228%22%3Enode%3C/tspan%3E%3C/text%3E%3C/g%3E%3Cg%20id%3D%22Line_22%22%3E%3Cline%20x1%3D%22581.65744%22%20y1%3D%22273.87335%22%20x2%3D%22572.72384%22%20y2%3D%22290.7517%22%20marker-end%3D%22url%28%23FilledArrow_Marker_3%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Line_23%22%3E%3Cline%20x1%3D%22599.2584%22%20y1%3D%22274.62692%22%20x2%3D%22605.6252%22%20y2%3D%22289.63432%22%20marker-end%3D%22url%28%23FilledArrow_Marker_3%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Line_24%22%3E%3Cline%20x1%3D%22579%22%20y1%3D%22317.625%22%20x2%3D%22587.1%22%20y2%3D%22317.625%22%20marker-end%3D%22url%28%23FilledArrow_Marker_3%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3Cg%20id%3D%22Line_25%22%3E%3Cline%20x1%3D%22465.8166%22%20y1%3D%22300.23284%22%20x2%3D%22528.6196%22%20y2%3D%22312.0179%22%20marker-end%3D%22url%28%23FilledArrow_Marker_3%29%22%20stroke%3D%22black%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20stroke-width%3D%221%22/%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E"/>

We compile the libxml2 C code into a web assembly module that uses a memory buffer as its heap.
This allows us to store data and share it with Javascript.
However, the data are in the form of C structs,
which are not easy to use in Javascript.
To solve this problem,
we create some Javascript classes that wrap the data and provide convenient methods.

The diagram illustrates how the XML's DOM structure is stored in the shared memory using many objects (C structs and C strings).
However, not all of these objects have a corresponding wrapper object on the Javascript side,
because only some nodes in the DOM structure may be accessed by its user.

## Object disposal

WebAssembly module does not have garbage collection,
which means that the users are resposible to the memory management and have to explicitly free the memory they use.

However, there is a clear ownership hierarchy among the objects,
so the users only have to free the root object and not every single object.
For instance,
when a doc object is freed,
all the nodes inside this doc are also freed.

To dispose an object, call the `dispose` method from its wrapper:

```js
doc.dispose();
```
