<!DOCTYPE html><html class="default" lang="en" data-base=".."><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>Memory Management | libxml2-wasm</title><meta name="description" content="Documentation for libxml2-wasm"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="../assets/style.css"/><link rel="stylesheet" href="../assets/highlight.css"/><script defer src="../assets/main.js"></script><script async src="../assets/icons.js" id="tsd-icons-script"></script><script async src="../assets/search.js" id="tsd-search-script"></script><script async src="../assets/navigation.js" id="tsd-nav-script"></script><script async src="../assets/hierarchy.js" id="tsd-hierarchy-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><div class="table-cell" id="tsd-search"><div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-search"></use></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div><div class="field"><div id="tsd-toolbar-links"><a href="https://github.com/jameslan/libxml2-wasm">GITHUB</a></div></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="../index.html" class="title">libxml2-wasm</a></div><div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><use href="../assets/icons.svg#icon-menu"></use></svg></a></div></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><ul class="tsd-breadcrumb"><li><a href="../modules.html">libxml2-wasm</a></li><li><a href="Memory_Management.html">Memory Management</a></li></ul></div><div class="tsd-panel tsd-typography"><a id="memory-model" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Memory Model<a href="#memory-model" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The architecture of libxml2-wasm is depicted in the following diagram.</p>
<p><img src="../media/mem.svg" alt=""></p>
<p>We compile the libxml2 C code into a web assembly module that utilizes a memory buffer as its heap.
This enables us to store data and share it with JavaScript.
However, the data is presented in the form of C <code>struct</code>s,
which pose challenges in JavaScript usage.
To address this issue,
we create JavaScript classes that encapsulate the data and provide user-friendly methods.</p>
<p>The diagram illustrates how the XML’s DOM structure is stored in the shared memory using numerous objects (C <code>struct</code>s and C strings).
Notably, not all these objects have corresponding wrapper objects on the JavaScript side,
as only certain nodes within the DOM structure are accessible by its user.</p>
<a id="object-disposal" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Object Disposal<a href="#object-disposal" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The WebAssembly module lacks garbage collection,
WebAssembly module does not have garbage collection,
meaning users are responsible for memory management and must explicitly free the memory they allocate.</p>
<p>However, there exists a clear ownership hierarchy among objects,
so users only need to free the root object rather than every individual node.
For instance,
when a doc object is freed,
all the nodes within it are also freed.</p>
<p>To dispose an object, invoke the <code>dispose</code> method from its wrapper:</p>
<pre><code class="js"><span class="hl-4">doc</span><span class="hl-1">.</span><span class="hl-0">dispose</span><span class="hl-1">();</span>
</code><button type="button">Copy</button></pre>

<p>The proposed <code>using</code> declaration, which is already available in TypeScript 5.2, is also supported.
If your environment supports it, you can use:</p>
<pre><code class="typescript"><span class="hl-5">using</span><span class="hl-1"> </span><span class="hl-6">doc</span><span class="hl-1"> = </span><span class="hl-4">XmlDocument</span><span class="hl-1">.</span><span class="hl-0">fromBuffer</span><span class="hl-1">(</span><span class="hl-4">xmlBuffer</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>at the end of the local scope of <code>doc</code>,
<code>[Symbol.dispose]()</code> is automatically called.</p>
<p>In addition to the DOM, other objects that own Web Assembly memory also need to be disposed.
These classes inherit from the base class <a href="../classes/libxml2-wasm.disposable.XmlDisposable.html" class="tsd-kind-class"><code>XmlDisposable</code></a>.</p>
<a id="garbage-collection" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Garbage Collection<a href="#garbage-collection" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>The JavaScript classes (subclasses of <code>XmlDisposable</code>) owned by the JavaScript runtime can be automatically garbage collected.
Once they are GC'ed, they attempt to release the managed resource if the <code>dispose()</code> method has not been called.</p>
<p>While this automatic dispose serves as a useful workaround, it is not a perfect solution.</p>
<p>The DOM object tree, stored in shared memory, holds all the XML content information.
In almost all cases, it consumes significantly more memory compared to the JavaScript wrapper objects.
Additionally, the shared memory is much smaller than the memory where the JavaScript objects reside.
Therefore, it’s highly probable that the out-of-memory error occurs before the garbage collector is triggered.</p>
<a id="diagnostics" class="tsd-anchor"></a><h1 class="tsd-anchor-link">Diagnostics<a href="#diagnostics" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24"><use href="../assets/icons.svg#icon-anchor"></use></svg></a></h1><p>It’s challenging to write leak-free code.
libxml2-wasm offers a memory tracker to aid in identifying the leaked objects.</p>
<p>To enable the memory tracker:</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">diag</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;libxml2-wasm&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">diag</span><span class="hl-1">.</span><span class="hl-0">configure</span><span class="hl-1">({ </span><span class="hl-4">enabled:</span><span class="hl-1"> </span><span class="hl-5">true</span><span class="hl-1"> });</span>
</code><button type="button">Copy</button></pre>

<p>After executing the code for a while,
you can let the tool generate a memory allocation report to check the number of objects allocated but not disposed:</p>
<pre><code class="ts"><span class="hl-3">import</span><span class="hl-1"> { </span><span class="hl-4">diag</span><span class="hl-1"> } </span><span class="hl-3">from</span><span class="hl-1"> </span><span class="hl-2">&#39;libxml2-wasm&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-4">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-4">diag</span><span class="hl-1">.</span><span class="hl-0">report</span><span class="hl-1">());</span>
</code><button type="button">Copy</button></pre>

</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-internal" name="internal"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Internal</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><use href="../assets/icons.svg#icon-chevronDown"></use></svg>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#memory-model"><span>Memory <wbr/>Model</span></a><a href="#object-disposal"><span>Object <wbr/>Disposal</span></a><a href="#garbage-collection"><span>Garbage <wbr/>Collection</span></a><a href="#diagnostics"><span>Diagnostics</span></a></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/jameslan/libxml2-wasm" class="tsd-nav-link">GITHUB</a></nav><nav class="tsd-navigation"><a href="../modules.html">libxml2-wasm</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p><p><script>
function inject() {
    var toolbar = document.getElementById('tsd-toolbar-links');
    var i;
    for (i = 0; i < toolbar.children.length; i++) {
        var e = toolbar.children[i];
        if (e.text == 'GITHUB') {
            e.innerHTML = '<svg width="24" height="24" style="margin-top: 8px;" xmlns="http://www.w3.org/2000/svg"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" style="fill:currentColor;"></path></svg>';
        }
    };
    var entry = document.getElementsByClassName('title')[0].href;
    fetch(new URL('../versions.json', entry).href)
        .then(function(resp) {
            return resp.json();
        })
        .then(function(versions) {
            var s = document.createElement('select');
            s.onchange = function(event) {
                window.location.href = event.target.value;
            }
            var i;
            for (i = 0; i < versions.length; i++) {
                var e = new URL('index.html', versions[i].url).href;
                var o = document.createElement('option');
                o.text = versions[i].version;
                o.value = versions[i].url;
                if (e == entry) {
                    o.selected = true;
                }
                s.appendChild(o);
            }
            toolbar.insertBefore(s, toolbar.firstChild);
        });
}
window.onload = inject;
</script></p></footer><div class="overlay"></div></body></html>
